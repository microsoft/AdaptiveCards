name: $(date:yyMM).$(date:dd)$(rev:rrr)

pr:
  branches:
    include:
    - main
  paths:
    include:
    - source/nodejs

pool:
  name: Azure Pipelines
  vmImage: windows-2019
  demands:
  - npm

parameters:
- name: target_packages
  displayName: "Which packages is going to be built."
  type: object
  default:
  - adaptivecards
  - adaptivecards-controls
  - adaptivecards-designer
  - adaptivecards-templating
  - adaptivecards-react

- name: test_projects
  displayName: "Which project is going to be consume the built packages."
  type: object
  default:
  - adaptivecards-ui-testapp
  - adaptivecards-react-testapp

steps:
- task: NodeTool@0
  name: NodeTool1
  displayName: Use Node 14.x
  inputs:
    versionSpec: 14.x

- bash: |
   npm i -g npm@latest
   npm ci 
   npx lerna bootstrap --ci
   npx lerna run release
  workingDirectory: source/nodejs
  displayName: 'Bash - lerna bootstrap'

- bash: |
   npx lerna run test
  workingDirectory: source/nodejs
  displayName: 'Run all tests'
  condition: failed() # This is disabled because of issue 6874

- ${{ each target_package in parameters.target_packages }}:
  - task: Npm@1
    displayName: '[${{ target_package }}] npm pack'
    inputs:
      command: custom
      customCommand: pack
      workingDir: source/nodejs/${{ target_package }}
  
  - task: CopyFiles@2
    inputs:
      sourceFolder: source/nodejs/${{ target_package }}
      contents: '${{ target_package }}*.tgz' 
      targetFolder: ../
    displayName: 'Copy tgz to ../'

- bash: |
   git clean -dxf
   npm i
  workingDirectory: source/nodejs
  displayName: 'clean and re-install the package'

- ${{ each test_project in parameters.test_projects }}:
  - bash: |
      npm i ../../../../*.tgz --force
      cat package.json
      npm i
      npm run build
    workingDirectory: source/nodejs/${{ test_project }}
    displayName: 'Install the built package and build the [${{ test_project }}]'